<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½ä¼šè®®çºªè¦ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" href="/static/favicon.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤ æ™ºèƒ½ä¼šè®®çºªè¦ç”Ÿæˆå™¨</h1>
            <p class="subtitle">åŸºäºAIçš„ä¸“ä¸šä¼šè®®è®°å½•ç³»ç»Ÿ - å¤šæ–‡æ¡£èƒŒæ™¯ç†è§£ â€¢ æ™ºèƒ½æœ¯è¯­æ ‡å‡†åŒ– â€¢ ç»“æ„åŒ–çºªè¦ç”Ÿæˆ</p>
            <div class="system-info">
                <span class="device-info">ğŸ–¥ï¸ è½¬å½•è®¾å¤‡: {{ whisper_device.upper() }}</span>
                <span class="config-status">
                    {% if config_status.openai_configured %}
                        <span class="status-ok">âœ… OpenAIå·²é…ç½®</span>
                    {% else %}
                        <span class="status-warning">âš ï¸ OpenAIæœªé…ç½®</span>
                    {% endif %}
                    {% if config_status.ollama_available %}
                        <span class="status-ok">âœ… Ollamaå¯ç”¨</span>
                    {% else %}
                        <span class="status-warning">âš ï¸ Ollamaä¸å¯ç”¨</span>
                    {% endif %}
                </span>
            </div>
        </header>

        <main>
            <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="connection-status" id="connectionStatus">
                <span id="connectionIndicator">ğŸ”´ è¿æ¥ä¸­...</span>
            </div>

            <!-- ä¸Šä¼ è¡¨å• -->
            <div class="upload-section" id="uploadSection">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="video">
                            <i class="icon">ğŸ“¹</i>
                            ä¼šè®®è§†é¢‘æ–‡ä»¶ (.mov/.mp4/.avi)
                        </label>
                        <input type="file" id="video" name="video" accept="video/*" required />
                        <div class="file-info" id="videoInfo"></div>
                    </div>

                    <div class="form-group">
                        <label for="docs">
                            <i class="icon">ğŸ“„</i>
                            å‚è€ƒæ–‡æ¡£ (PDF/DOCX/MD/TXTï¼Œå¯å¤šé€‰)
                        </label>
                        <input type="file" id="docs" name="docs[]" accept=".pdf,.doc,.docx,.md,.txt" multiple />
                        <div class="file-info" id="docsInfo"></div>
                        <div class="form-help">
                            <span class="info">ğŸ’¡ æ”¯æŒå¤šä¸ªæ–‡æ¡£ï¼Œå…¶ä¸­PDFæ–‡ä»¶å°†è¿›è¡Œ**æ–‡æœ¬æå–**å’Œ**å›¾è¡¨åˆ†æ**ï¼ˆéœ€ä½¿ç”¨OpenAIæœåŠ¡ï¼‰</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="context">
                            <i class="icon">ğŸ“</i>
                            è¡¥å……èƒŒæ™¯ä¿¡æ¯ (Context)
                        </label>
                        <textarea id="context" name="context" rows="6" placeholder="åœ¨æ­¤è¾“å…¥è¡¥å……çš„èƒŒæ™¯ä¿¡æ¯ã€ä¼šè®®ç›®æ ‡ã€å…³é”®æœ¯è¯­ç­‰...&#10;&#10;ğŸ“Œ AIå°†ç»“åˆæ­¤å¤„çš„èƒŒæ™¯ä¿¡æ¯å’Œä¸‹æ–¹ä¸Šä¼ çš„å‚è€ƒæ–‡æ¡£ï¼Œè¿›è¡Œæ›´ç²¾å‡†çš„åˆ†æã€‚"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="aiProvider">
                            <i class="icon">ğŸ¤–</i>
                            AIæœåŠ¡æä¾›å•†
                        </label>
                        <select id="aiProvider" name="aiProvider">
                            {% if config_status.openai_configured %}
                                <option value="openai">OpenAI / OpenRouter</option>
                            {% endif %}
                            {% if config_status.ollama_available %}
                                <option value="ollama">æœ¬åœ°Ollama</option>
                            {% endif %}
                        </select>
                        <div class="form-help">
                            {% if not config_status.openai_configured and not config_status.ollama_available %}
                                <span class="error">âŒ æœªé…ç½®ä»»ä½•AIæœåŠ¡ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</span>
                            {% elif config_status.openai_configured and not config_status.ollama_available %}
                                <span class="info">ğŸ¤– ä¸“ä¸šAIå¤„ç†ï¼šå¤šæ–‡æ¡£èƒŒæ™¯ç†è§£ã€æ™ºèƒ½æœ¯è¯­æ ‡å‡†åŒ–ã€ç»“æ„åŒ–çºªè¦ç”Ÿæˆã€å†³ç­–è¡ŒåŠ¨é¡¹æå–</span>
                            {% elif not config_status.openai_configured and config_status.ollama_available %}
                                <span class="info">ğŸ¤– ä¸“ä¸šAIå¤„ç†ï¼šå¤šæ–‡æ¡£èƒŒæ™¯ç†è§£ã€æ™ºèƒ½æœ¯è¯­æ ‡å‡†åŒ–ã€ç»“æ„åŒ–çºªè¦ç”Ÿæˆã€å†³ç­–è¡ŒåŠ¨é¡¹æå–</span>
                            {% else %}
                                <span class="info">ğŸ¤– ä¸“ä¸šAIå¤„ç†ï¼šå¤šæ–‡æ¡£èƒŒæ™¯ç†è§£ã€æ™ºèƒ½æœ¯è¯­æ ‡å‡†åŒ–ã€ç»“æ„åŒ–çºªè¦ç”Ÿæˆã€å†³ç­–è¡ŒåŠ¨é¡¹æå–</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ollama æ¨¡å‹ä¿¡æ¯ -->
                    {% if config_status.ollama_available %}
                    <div class="ai-info" id="ollamaInfo" style="display: none;">
                        <div class="form-group">
                            <label>
                                <i class="icon">ğŸ¦™</i>
                                å¯ç”¨çš„Ollamaæ¨¡å‹
                            </label>
                            <div class="model-list">
                                {% for model in ollama_models %}
                                <div class="model-item">
                                    <span class="model-name">{{ model.name }}</span>
                                    <span class="model-size">({{ model.size }})</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <button type="submit" class="submit-btn" 
                            {% if not config_status.openai_configured and not config_status.ollama_available %}disabled{% endif %}>
                        <i class="icon">ğŸš€</i>
                        å¼€å§‹ç”Ÿæˆä¼šè®®çºªè¦
                    </button>
                </form>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <h2>å¤„ç†è¿›åº¦</h2>
                <div class="session-info">
                    <span>ä¼šè¯ID: <code id="sessionIdDisplay">--</code></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-info">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="time-info">
                        <span id="elapsedTime">å·²ç”¨æ—¶: 0ç§’</span>
                        <span id="remainingTime" style="display: none;">é¢„è®¡å‰©ä½™: --</span>
                    </div>
                </div>
                
                <div class="progress-steps" id="progressSteps">
                    <!-- è¿›åº¦æ­¥éª¤å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>

                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <div class="debug-info" id="debugInfo" style="display: none;">
                    <h3>è°ƒè¯•ä¿¡æ¯</h3>
                    <pre id="debugLog"></pre>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="result-section" id="resultSection" style="display: none;">
                <h2>ğŸ‰ å¤„ç†å®Œæˆï¼</h2>
                <div class="result-info">
                    <div class="result-stats">
                        <div class="stat-item">
                            <i class="icon">â±ï¸</i>
                            <span>å¤„ç†æ—¶é—´</span>
                            <span id="processingTime">--</span>
                        </div>
                        <div class="stat-item">
                            <i class="icon">ğŸµ</i>
                            <span>éŸ³é¢‘æ—¶é•¿</span>
                            <span id="audioDuration">--</span>
                        </div>
                        <div class="stat-item">
                            <i class="icon">ğŸ–¥ï¸</i>
                            <span>å¤„ç†è®¾å¤‡</span>
                            <span>{{ whisper_device.upper() }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="icon">ğŸ¤–</i>
                            <span>AIæœåŠ¡</span>
                            <span id="aiService">--</span>
                        </div>
                        <div class="stat-item">
                            <i class="icon">ğŸŒ</i>
                            <span>æ£€æµ‹è¯­è¨€</span>
                            <span id="detectedLang">--</span>
                        </div>
                    </div>
                </div>
                <div class="result-downloads">
                    <a href="#" id="downloadRaw" class="download-btn" style="display: none;">
                        <i class="icon">ğŸ“„</i>
                        ä¸‹è½½åŸå§‹è½¬å½•æ–‡æœ¬
                    </a>
                    <a href="#" id="downloadCorrected" class="download-btn" style="display: none;">
                        <i class="icon">âœ¨</i>
                        ä¸‹è½½AIçº æ­£åè½¬å½•
                    </a>
                    <a href="#" id="downloadReport" class="download-btn" style="display: none;">
                        <i class="icon">ğŸ“Š</i>
                        ä¸‹è½½å®Œæ•´ä¼šè®®æŠ¥å‘Š
                    </a>
                </div>
                <div class="result-actions">
                    <button id="newMeeting" class="new-meeting-btn">
                        <i class="icon">ğŸ†•</i>
                        å¤„ç†æ–°ä¼šè®®
                    </button>
                    <button id="toggleDebug" class="debug-btn">
                        <i class="icon">ğŸ”</i>
                        æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                    </button>
                </div>
            </div>

            <!-- é”™è¯¯æ˜¾ç¤º -->
            <div class="error-section" id="errorSection" style="display: none;">
                <h2>âŒ å¤„ç†å‡ºé”™</h2>
                <div class="error-message" id="errorMessage"></div>
                <div class="error-details" id="errorDetails" style="display: none;">
                    <h3>é”™è¯¯è¯¦æƒ…</h3>
                    <pre id="errorLog"></pre>
                </div>
                <div class="error-actions">
                    <button id="retryBtn" class="retry-btn">
                        <i class="icon">ğŸ”„</i>
                        é‡è¯•
                    </button>
                    <button id="backToFormBtn" class="back-btn">
                        <i class="icon">â¬…ï¸</i>
                        è¿”å›è¡¨å•
                    </button>
                    <button id="toggleErrorDetails" class="debug-btn">
                        <i class="icon">ğŸ”</i>
                        æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
                    </button>
                </div>
            </div>
        </main>

        <footer>
            <p>æ”¯æŒä¸­è‹±æ–‡åŒè¯­è¯†åˆ« | åŸºäºWhisper Mediumæ¨¡å‹ | å¤šæ–‡æ¡£æ™ºèƒ½åˆ†æ | ä¸“ä¸šçºªè¦ç”Ÿæˆ | é›†æˆOpenAI/OpenRouterå’ŒOllama</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let currentSessionId = null;
        let startTime = null;
        let progressInterval = null;
        let debugMode = false;

        // DOMå…ƒç´ 
        const uploadForm = document.getElementById('uploadForm');
        const uploadSection = document.getElementById('uploadSection');
        const progressSection = document.getElementById('progressSection');
        const resultSection = document.getElementById('resultSection');
        const errorSection = document.getElementById('errorSection');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const sessionIdDisplay = document.getElementById('sessionIdDisplay');
        const progressFill = document.getElementById('progressFill');
        const progressPercentage = document.getElementById('progressPercentage');
        const progressSteps = document.getElementById('progressSteps');
        const videoInput = document.getElementById('video');
        const docsInput = document.getElementById('docs');
        const videoInfo = document.getElementById('videoInfo');
        const docsInfo = document.getElementById('docsInfo');
        const aiProvider = document.getElementById('aiProvider');
        const ollamaInfo = document.getElementById('ollamaInfo');
        const downloadRaw = document.getElementById('downloadRaw');
        const downloadCorrected = document.getElementById('downloadCorrected');
        const downloadReport = document.getElementById('downloadReport');
        const newMeetingBtn = document.getElementById('newMeeting');
        const retryBtn = document.getElementById('retryBtn');
        const backToFormBtn = document.getElementById('backToFormBtn');
        const errorMessage = document.getElementById('errorMessage');
        const elapsedTime = document.getElementById('elapsedTime');
        const remainingTime = document.getElementById('remainingTime');
        const processingTime = document.getElementById('processingTime');
        const audioDuration = document.getElementById('audioDuration');
        const aiService = document.getElementById('aiService');
        const detectedLang = document.getElementById('detectedLang');
        const debugInfo = document.getElementById('debugInfo');
        const debugLog = document.getElementById('debugLog');
        const errorDetails = document.getElementById('errorDetails');
        const errorLog = document.getElementById('errorLog');
        const toggleDebug = document.getElementById('toggleDebug');
        const toggleErrorDetails = document.getElementById('toggleErrorDetails');

        // è°ƒè¯•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            console.log(logMessage);
            
            if (debugLog) {
                debugLog.textContent += logMessage + '\n';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initSocket() {
            try {
                socket = io();
                log('æ­£åœ¨è¿æ¥WebSocketæœåŠ¡å™¨...');
                
                socket.on('connect', function() {
                    log('WebSocketè¿æ¥æˆåŠŸ');
                    connectionIndicator.textContent = 'ğŸŸ¢ å·²è¿æ¥';
                    connectionIndicator.className = 'connected';
                });

                socket.on('disconnect', function() {
                    log('WebSocketè¿æ¥æ–­å¼€', 'warning');
                    connectionIndicator.textContent = 'ğŸ”´ è¿æ¥æ–­å¼€';
                    connectionIndicator.className = 'disconnected';
                });

                socket.on('connect_error', function(error) {
                    log(`WebSocketè¿æ¥é”™è¯¯: ${error}`, 'error');
                    connectionIndicator.textContent = 'ğŸ”´ è¿æ¥é”™è¯¯';
                    connectionIndicator.className = 'error';
                });

                socket.on('progress_update', function(data) {
                    log(`æ”¶åˆ°è¿›åº¦æ›´æ–°: ${JSON.stringify(data)}`);
                    updateProgress(data);
                });

                socket.on('processing_complete', function(data) {
                    log(`å¤„ç†å®Œæˆ: ${JSON.stringify(data)}`);
                    stopProgressTimer();
                    showResult(data);
                });

                socket.on('error', function(data) {
                    log(`æ”¶åˆ°é”™è¯¯: ${JSON.stringify(data)}`, 'error');
                    stopProgressTimer();
                    showError(data.message, data);
                });

            } catch (error) {
                log(`WebSocketåˆå§‹åŒ–å¤±è´¥: ${error}`, 'error');
                connectionIndicator.textContent = 'ğŸ”´ åˆå§‹åŒ–å¤±è´¥';
            }
        }

        // æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
        videoInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const size = (file.size / 1024 / 1024).toFixed(2);
                videoInfo.innerHTML = `
                    <strong>${file.name}</strong><br>
                    å¤§å°: ${size} MB<br>
                    ç±»å‹: ${file.type}
                `;
                log(`é€‰æ‹©è§†é¢‘æ–‡ä»¶: ${file.name} (${size}MB)`);
            }
        });

        docsInput.addEventListener('change', function() {
            const files = Array.from(this.files);
            if (files.length > 0) {
                const fileDetails = files.map(f => {
                    const sizeKB = (f.size / 1024).toFixed(1);
                    const type = f.type || 'æœªçŸ¥ç±»å‹';
                    return `â€¢ ${f.name} (${sizeKB} KB)`;
                }).join('<br>');
                
                const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                const size = (totalSize / 1024 / 1024).toFixed(2);
                
                docsInfo.innerHTML = `
                    <strong>${files.length}ä¸ªå‚è€ƒæ–‡æ¡£:</strong><br>
                    ${fileDetails}<br>
                    <strong>æ€»å¤§å°: ${size} MB</strong>
                `;
                log(`é€‰æ‹©å‚è€ƒæ–‡æ¡£: ${files.length}ä¸ªæ–‡ä»¶ (${size}MB)`);
            } else {
                docsInfo.innerHTML = '';
            }
        });

        // AIæœåŠ¡æä¾›å•†é€‰æ‹©
        aiProvider.addEventListener('change', function() {
            if (this.value === 'ollama' && ollamaInfo) {
                ollamaInfo.style.display = 'block';
            } else if (ollamaInfo) {
                ollamaInfo.style.display = 'none';
            }
            log(`é€‰æ‹©AIæœåŠ¡: ${this.value}`);
        });

        // è¡¨å•æäº¤
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            log('å¼€å§‹æäº¤è¡¨å•...');
            
            // éªŒè¯WebSocketè¿æ¥
            if (!socket || !socket.connected) {
                showError('WebSocketè¿æ¥æœªå»ºç«‹ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // éªŒè¯è§†é¢‘æ–‡ä»¶
            if (!videoInput.files.length) {
                showError('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
                return;
            }

            // éªŒè¯AIæœåŠ¡é…ç½®
            if (!aiProvider.value) {
                showError('è¯·é€‰æ‹©AIæœåŠ¡æä¾›å•†');
                return;
            }
            
            const formData = new FormData(this);
            log(`æäº¤è¡¨å•æ•°æ® - AIæœåŠ¡: ${aiProvider.value}`);
            
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                log(`æœåŠ¡å™¨å“åº”: ${JSON.stringify(result)}`);
                
                if (response.ok && result.status === 'processing') {
                    currentSessionId = result.session_id;
                    log(`è·å¾—ä¼šè¯ID: ${currentSessionId}`);
                    
                    // åŠ å…¥WebSocketæˆ¿é—´
                    socket.emit('join', currentSessionId);
                    
                    startTime = Date.now();
                    showProgressSection();
                    startProgressTimer();
                } else {
                    showError(result.error || 'å¤„ç†è¯·æ±‚å¤±è´¥', result);
                }
            } catch (error) {
                log(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error}`, 'error');
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        });

        // æ˜¾ç¤ºè¿›åº¦
        function showProgressSection() {
            uploadSection.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            
            if (currentSessionId) {
                sessionIdDisplay.textContent = currentSessionId.substring(0, 8) + '...';
            }
            
            log('æ˜¾ç¤ºè¿›åº¦é¡µé¢');
        }

        // å¼€å§‹è¿›åº¦è®¡æ—¶å™¨
        function startProgressTimer() {
            progressInterval = setInterval(function() {
                if (startTime) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    elapsedTime.textContent = `å·²ç”¨æ—¶: ${elapsed}ç§’`;
                }
            }, 1000);
            log('å¯åŠ¨è¿›åº¦è®¡æ—¶å™¨');
        }

        // åœæ­¢è¿›åº¦è®¡æ—¶å™¨
        function stopProgressTimer() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
                log('åœæ­¢è¿›åº¦è®¡æ—¶å™¨');
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(data) {
            try {
                const percentage = Math.round(data.percentage || 0);
                progressFill.style.width = percentage + '%';
                progressPercentage.textContent = percentage + '%';
                
                // æ˜¾ç¤ºé¢„è®¡å‰©ä½™æ—¶é—´
                if (data.estimated_remaining_time && data.estimated_remaining_time > 0) {
                    const remainingSeconds = Math.ceil(data.estimated_remaining_time);
                    remainingTime.textContent = `é¢„è®¡å‰©ä½™: ${remainingSeconds}ç§’`;
                    remainingTime.style.display = 'inline';
                } else {
                    remainingTime.style.display = 'none';
                }
                
                // æ›´æ–°æ­¥éª¤æ˜¾ç¤º
                if (data.steps && Array.isArray(data.steps)) {
                    progressSteps.innerHTML = '';
                    data.steps.forEach((step, index) => {
                        const stepDiv = document.createElement('div');
                        stepDiv.className = 'progress-step';
                        stepDiv.classList.add('status-' + step.status);
                        
                        const icon = step.status === 'completed' ? 'âœ…' : 
                                   step.status === 'processing' ? 'â³' : 'â¸ï¸';
                        
                        let progressBar = '';
                        if (step.status === 'processing' && step.progress_percentage > 0) {
                            progressBar = `
                                <div class="step-progress">
                                    <div class="step-progress-bar">
                                        <div class="step-progress-fill" style="width: ${step.progress_percentage}%"></div>
                                    </div>
                                    <span class="step-progress-text">${step.progress_percentage}%</span>
                                </div>
                            `;
                        } else if (step.status === 'processing' && step.description.includes('/')) {
                             progressBar = `
                                <div class="step-progress">
                                    <div class="step-progress-bar">
                                        <div class="step-progress-fill-animated"></div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        stepDiv.innerHTML = `
                            <div class="step-icon">${icon}</div>
                            <div class="step-content">
                                <div class="step-name">${step.name}</div>
                                <div class="step-description">${step.description}</div>
                                ${progressBar}
                            </div>
                        `;
                        
                        progressSteps.appendChild(stepDiv);
                    });
                }
                
                log(`è¿›åº¦æ›´æ–°: ${percentage}% - å½“å‰æ­¥éª¤: ${data.current_step}/${data.total_steps}`);
                
            } catch (error) {
                log(`æ›´æ–°è¿›åº¦å¤±è´¥: ${error}`, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(data) {
            uploadSection.style.display = 'none';
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            errorSection.style.display = 'none';
            
            log(`æ˜¾ç¤ºç»“æœé¡µé¢: ${JSON.stringify(data)}`);
            
            // è®¾ç½®ä¸‹è½½é“¾æ¥
            let downloadCount = 0;
            
            if (data.raw_transcript_path) {
                const rawFilename = data.raw_transcript_path.split('/').pop();
                downloadRaw.href = `/download/${rawFilename}`;
                downloadRaw.style.display = 'inline-block';
                downloadCount++;
                log(`è®¾ç½®åŸå§‹è½¬å½•ä¸‹è½½é“¾æ¥: ${rawFilename}`);
            }
            
            if (data.corrected_transcript_path) {
                const correctedFilename = data.corrected_transcript_path.split('/').pop();
                downloadCorrected.href = `/download/${correctedFilename}`;
                downloadCorrected.style.display = 'inline-block';
                downloadCount++;
                log(`è®¾ç½®çº æ­£è½¬å½•ä¸‹è½½é“¾æ¥: ${correctedFilename}`);
            }
            
            if (data.report_path) {
                const reportFilename = data.report_path.split('/').pop();
                downloadReport.href = `/download/${reportFilename}`;
                downloadReport.style.display = 'inline-block';
                downloadCount++;
                log(`è®¾ç½®æŠ¥å‘Šä¸‹è½½é“¾æ¥: ${reportFilename}`);
            }
            
            // æ˜¾ç¤ºå¤„ç†ç»Ÿè®¡
            if (data.processing_time) {
                processingTime.textContent = `${data.processing_time.toFixed(1)}ç§’`;
            }
            
            if (data.audio_duration) {
                const duration = data.audio_duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                audioDuration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            if (data.ai_provider) {
                aiService.textContent = data.ai_provider.toUpperCase();
            }
            
            if (data.detected_language) {
                detectedLang.textContent = data.detected_language;
            }
            
            log(`å¤„ç†å®Œæˆ - ç”Ÿæˆäº†${downloadCount}ä¸ªä¸‹è½½æ–‡ä»¶`);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message, details = null) {
            uploadSection.style.display = 'none';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            errorSection.style.display = 'block';
            
            errorMessage.textContent = message;
            
            if (details) {
                errorLog.textContent = JSON.stringify(details, null, 2);
                log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(details)}`, 'error');
            }
            
            log(`æ˜¾ç¤ºé”™è¯¯: ${message}`, 'error');
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            uploadSection.style.display = 'block';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            
            // é‡ç½®è¡¨å•
            uploadForm.reset();
            videoInfo.innerHTML = '';
            docsInfo.innerHTML = '';
            currentSessionId = null;
            startTime = null;
            stopProgressTimer();
            
            // é‡ç½®ä¸‹è½½é“¾æ¥
            downloadRaw.style.display = 'none';
            downloadCorrected.style.display = 'none';
            downloadReport.style.display = 'none';
            
            // é‡ç½®AIé…ç½®æ˜¾ç¤º
            if (aiProvider.value === 'ollama' && ollamaInfo) {
                ollamaInfo.style.display = 'block';
            } else if (ollamaInfo) {
                ollamaInfo.style.display = 'none';
            }
            
            log('é‡ç½®è¡¨å•');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        newMeetingBtn.addEventListener('click', resetForm);
        retryBtn.addEventListener('click', resetForm);
        backToFormBtn.addEventListener('click', resetForm);

        toggleDebug.addEventListener('click', function() {
            debugMode = !debugMode;
            if (debugMode) {
                debugInfo.style.display = 'block';
                this.textContent = 'ğŸ” éšè—è°ƒè¯•ä¿¡æ¯';
            } else {
                debugInfo.style.display = 'none';
                this.textContent = 'ğŸ” æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
            }
        });

        toggleErrorDetails.addEventListener('click', function() {
            if (errorDetails.style.display === 'none') {
                errorDetails.style.display = 'block';
                this.textContent = 'ğŸ” éšè—é”™è¯¯è¯¦æƒ…';
            } else {
                errorDetails.style.display = 'none';
                this.textContent = 'ğŸ” æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…';
            }
        });

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–WebSocketè¿æ¥...');
            initSocket();
            
            // åˆå§‹åŒ–AIæä¾›å•†é€‰æ‹©
            if (aiProvider.value === 'ollama' && ollamaInfo) {
                ollamaInfo.style.display = 'block';
            }
            
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (socket) {
                socket.disconnect();
            }
            stopProgressTimer();
        });
    </script>
</body>
</html>